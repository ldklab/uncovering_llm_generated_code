The Node.js code provided is a module that exports a function enabling the killing of a process tree given a process ID (PID). It handles different operating systems like Windows, macOS (Darwin), and Linux. The detailed functionality is as follows:

1. **Argument Handling and Validation**:
   - The function accepts three arguments: `pid` (process ID to start killing from), `signal` (the signal to send, defaults to 'SIGTERM'), and `callback` (a function executed after the process is killed or if an error occurs).
   - If only two arguments are provided, and the second is a function, it assumes that this is a callback function, and no signal is explicitly provided.
   - The `pid` is converted into an integer, and if itâ€™s not a number, an error is thrown or passed to the callback.

2. **Process Tree Structure**:
   - A tree structure is initialized using an object with `pid` as the root. This structure helps manage and track processes and their child processes.

3. **Platform-Specific Process Killing**:
   - For **Windows** (`win32`), it uses `taskkill` to terminate the process and its descendants forcefully.
   - For **macOS** (`darwin`) and **Linux** (default case), it uses different commands to find child processes (`pgrep` and `ps` respectively) and builds the process tree recursively.

4. **Functions**:
   - `buildProcessTree`: Recursively constructs a tree of processes stemming from the given `pid` by spawning child processes lists.
   - `killAll`: Traverses the built process tree and attempts to kill all processes, ensuring it doesn't re-kill already killed processes.
   - `killPid`: Attempts to kill a single process by PID and handles 'process does not exist' errors (`ESRCH`).

5. **Error Handling**:
   - Error handling is done by either calling a callback function with the error object or by letting the error propagate by throwing it.

Here is a cleaned-up and documented version of the code:

```javascript
'use strict';

const { spawn, exec } = require('child_process');

module.exports = function (pid, signal, callback) {
    if (typeof signal === 'function' && callback === undefined) {
        callback = signal;
        signal = undefined;
    }

    pid = parseInt(pid);
    if (Number.isNaN(pid)) {
        if (callback) {
            return callback(new Error("pid must be a number"));
        } else {
            throw new Error("pid must be a number");
        }
    }

    const tree = { [pid]: [] };
    const pidsToProcess = { [pid]: 1 };

    const platformActions = {
        win32: () => exec(`taskkill /pid ${pid} /T /F`, callback),
        darwin: () => findProcessTreeAndKill(pid, tree, pidsToProcess, spawnPgrep, () => killAll(tree, signal, callback)),
        default: () => findProcessTreeAndKill(pid, tree, pidsToProcess, spawnPs, () => killAll(tree, signal, callback)),
    };

    (platformActions[process.platform] || platformActions.default)();
};

function killAll(tree, signal, callback) {
    const killed = {};
    try {
        Object.keys(tree).forEach((pid) => {
            tree[pid].forEach((childPid) => {
                if (!killed[childPid]) {
                    killPid(childPid, signal);
                    killed[childPid] = 1;
                }
            });
            if (!killed[pid]) {
                killPid(pid, signal);
                killed[pid] = 1;
            }
        });
    } catch (err) {
        return callback ? callback(err) : throw err;
    }
    if (callback) callback();
}

function killPid(pid, signal) {
    try {
        process.kill(parseInt(pid, 10), signal);
    } catch (err) {
        if (err.code !== 'ESRCH') throw err;
    }
}

function findProcessTreeAndKill(parentPid, tree, pidsToProcess, spawnProcessListFn, cb) {
    const processList = spawnProcessListFn(parentPid);
    let dataString = '';

    processList.stdout.on('data', (data) => {
        dataString += data.toString('ascii');
    });

    processList.on('close', (code) => {
        delete pidsToProcess[parentPid];

        if (code !== 0) {
            if (Object.keys(pidsToProcess).length === 0) cb();
            return;
        }

        dataString.match(/\d+/g).forEach((pid) => {
            pid = parseInt(pid, 10);
            tree[parentPid].push(pid);
            tree[pid] = [];
            pidsToProcess[pid] = 1;
            findProcessTreeAndKill(pid, tree, pidsToProcess, spawnProcessListFn, cb);
        });
    });
}

function spawnPgrep(parentPid) {
    return spawn('pgrep', ['-P', parentPid]);
}

function spawnPs(parentPid) {
    return spawn('ps', ['-o', 'pid', '--no-headers', '--ppid', parentPid]);
}
```